{% extends "layout.html" %}
{% block content %}
<div class="container mt-5">
    <div class="card shadow border-0" style="border-radius: 15px;">
        <div class="card-header bg-primary text-white py-3" style="border-radius: 15px 15px 0 0;">
            <h4 class="mb-0"><i class="fas fa-user-edit me-2"></i>Full Record Update: {{ patient.first_name }}</h4>
        </div>
        <div class="card-body p-4">
            <form id="updateForm" action="/update_patient/{{ patient.id }}" method="POST" enctype="multipart/form-data">
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold">First Name</label>
                        <input type="text" name="first_name" class="form-control shadow-sm" value="{{ patient.first_name }}" required>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold">Last Name</label>
                        <input type="text" name="last_name" class="form-control shadow-sm" value="{{ patient.last_name }}" required>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Insurance ID</label>
                        <input type="text" name="insurance_number" class="form-control shadow-sm" value="{{ patient.insurance_number }}" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Age</label>
                        <input type="number" name="age" class="form-control shadow-sm" value="{{ patient.age }}" required>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Weight (kg)</label>
                        <input type="number" step="0.1" name="weight" class="form-control shadow-sm" value="{{ patient.weight }}" required>
                    </div>
                </div>

                <div class="row mb-3 align-items-center">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Gender</label>
                        <select name="gender" class="form-select shadow-sm">
                            <option value="Male" {% if patient.gender == 'Male' %}selected{% endif %}>Male</option>
                            <option value="Female" {% if patient.gender == 'Female' %}selected{% endif %}>Female</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Next Appointment</label>
                        <input type="date" name="appt_date" class="form-control shadow-sm" value="{{ patient.appt_date }}">
                    </div>
                    <div class="col-md-4 pt-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="allergies" value="Yes" id="editAllergy" {% if patient.allergies == 'Yes' %}checked{% endif %}>
                            <label class="form-check-label fw-bold" for="editAllergy">Known Allergies</label>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Medical History / Notes</label>
                    <textarea name="history" class="form-control shadow-sm" rows="4">{{ patient.medical_history }}</textarea>
                </div>

                <div class="p-3 mb-4 rounded border" style="background-color: #f8f9fa;">
                    <label class="form-label fw-bold">Update Profile Photo</label>
                    <div class="d-flex align-items-center">
                        <img src="{{ url_for('static', filename=patient.patient_img) }}" class="rounded-circle me-3" style="width: 60px; height: 60px; object-fit: cover; border: 2px solid #0d6efd;">
                        <input type="file" name="patient_img" class="form-control shadow-sm" accept="image/*">
                    </div>
                    <small class="text-muted">Leave empty to keep current photo.</small>
                </div>
                <hr>
<h5 class="text-primary mb-3">Manage Existing Reports</h5>
<div class="row mb-4">
    {% for doc in documents %}
    <div class="col-md-3 mb-3 text-center" id="doc-container-{{ doc.id }}">
        <div class="border rounded p-2 bg-light">
            {% if doc.file_path.endswith('.pdf') %}
                <i class="fas fa-file-pdf fa-3x text-danger"></i>
            {% else %}
                <img src="{{ url_for('static', filename=doc.file_path) }}" class="img-fluid rounded mb-2" style="height: 80px; object-fit: cover;">
            {% endif %}
            <div class="small text-muted">{{ doc.document_date }}</div>
            
            <button type="button" class="btn btn-sm btn-danger mt-2" onclick="confirmDeleteReport('{{ doc.id }}')">
                Remove
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<h5 class="text-success mb-3">Add New Reports</h5>
<div class="row border p-3 rounded bg-light mx-1">
    <div class="col-md-7">
        <label class="small fw-bold">Select New Files</label>
        <input type="file" name="medical_docs" class="form-control" multiple>
    </div>
    <div class="col-md-5">
        <label class="small fw-bold">Date for these new files</label>
        <input type="date" name="doc_date" class="form-control">
    </div>
</div>

                <div class="mt-5 pt-2">
                    <button type="button" onclick="confirmUpdate()" class="btn btn-primary btn-lg w-100 shadow py-3" style="border-radius: 10px; font-weight: bold;">
                        <i class="fas fa-check-circle me-2"></i>Apply Changes to Database
                    </button>
                    <div class="text-center mt-3">
                        <a href="/dashboard" class="text-muted text-decoration-none small">Discard and Exit</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
function confirmUpdate() {
    Swal.fire({
        title: 'Confirm Update?',
        text: "You are about to modify this patient's clinical record.",
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#0d6efd',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, Save Changes',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById('updateForm').submit();
        }
    })
}
</script>

<script>
function confirmDeleteReport(docId) {
    Swal.fire({
        title: 'Delete this report?',
        text: "This specific scan will be removed forever!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        confirmButtonText: 'Yes, remove it'
    }).then((result) => {
        if (result.isConfirmed) {
            // This tells Python to delete just this one report
            window.location.href = "/delete_report/" + docId + "?patient_id={{ patient.id }}";
        }
    })
}
</script>
{% endblock %}