{% extends "layout.html" %}

{% block content %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />

<div class="row g-4">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
                <h4 class="fw-bold mb-1"><i class="bi bi-calendar-plus text-primary me-2"></i>Appointment Booking</h4>
                <p class="text-muted small mb-0">Schedule new patient visits and manage upcoming consultations.</p>
            </div>
            <button class="btn btn-primary" onclick="window.scrollTo(0, document.body.scrollHeight);">
                <i class="bi bi-list-check me-2"></i>View Schedule
            </button>
        </div>
    </div>

    <!-- LEFT COLUMN: Booking Action -->
    <div class="col-lg-4">
        <!-- Step 1: Search -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <h6 class="mb-0 fw-bold"><i class="bi bi-search me-2 text-secondary"></i>1. Find Patient</h6>
            </div>
            <div class="card-body">
                <div class="position-relative">
                    <input type="text" id="patientSearch" class="form-control form-control-lg bg-light border-0"
                        placeholder="Name or ID..." autocomplete="off">
                    <div id="searchResults" class="list-group position-absolute w-100 shadow mt-2"
                        style="z-index: 1000; max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div class="form-text mt-2 small">Search to auto-fill patient details.</div>
            </div>
        </div>

        <!-- Step 2: Form -->
        <div id="bookingFormSection" class="card border-0 shadow-sm d-none animate__animated animate__fadeIn">
            <div class="card-header bg-primary text-white py-3">
                <h6 class="mb-0 fw-bold"><i class="bi bi-calendar-check me-2"></i>2. Schedule Visit</h6>
            </div>
            <div class="card-body p-4">
                <div class="mb-4 text-center">
                    <div class="bg-primary-subtle text-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-2"
                        style="width: 50px; height: 50px;">
                        <i class="bi bi-person-fill fs-4"></i>
                    </div>
                    <h5 class="fw-bold text-dark mb-0" id="selectedPatientName">Patient Name</h5>
                    <small class="text-muted" id="selectedPatientDetail">ID: --</small>
                </div>

                <form action="{{ url_for('book_appointment') }}" method="POST">
                    <input type="hidden" name="patient_id" id="selectedPatientId">

                    <div class="form-floating mb-3">
                        <input type="date" name="appointment_date" class="form-control bg-light border-0 fw-bold"
                            id="apptDate" required min="{{ get_today_date }}">
                        <label>Appointment Date</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input type="time" name="appointment_time" class="form-control bg-light border-0 fw-bold"
                            id="apptTime" required>
                        <label>Time Slot</label>
                    </div>

                    <div class="form-floating mb-4">
                        <input type="text" name="reason_for_visit" class="form-control bg-light border-0"
                            id="apptReason" placeholder="Reason" required>
                        <label>Reason for Visit</label>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-3 fw-bold shadow-sm">
                        Confirm Booking
                    </button>
                    <button type="button" class="btn btn-link text-muted w-100 mt-2 text-decoration-none small"
                        onclick="resetForm()">
                        Cancel & Search Again
                    </button>
                </form>
            </div>
        </div>

        <!-- Placeholder for Empty State -->
        <div id="bookingPlaceholder" class="card border-0 shadow-sm bg-light text-center p-5 border-dashed">
            <i class="bi bi-calendar-minus display-4 text-muted opacity-25 mb-3"></i>
            <h6 class="text-muted">No Patient Selected</h6>
            <p class="small text-muted mb-0">Search and select a patient to unlock the scheduling form.</p>
        </div>
    </div>

    <!-- RIGHT COLUMN: Calendar Availability -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold"><i class="bi bi-calendar3 me-2 text-secondary"></i>Availability Calendar</h6>
                <span class="badge bg-info-subtle text-info-emphasis">Read-Only View</span>
            </div>
            <div class="card-body p-0">
                <div id='calendar' class="p-3"></div>
            </div>
        </div>
    </div>

    <!-- SECTION: Upcoming Schedule Table -->
    <div class="col-12 mt-5">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold">Scheduled Appointments</h5>
            </div>
            <div class="p-3 bg-light border-bottom">
                <input type="text" id="searchAppt" class="form-control border-0 shadow-sm"
                    placeholder="Filter list by patient name...">
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="appointmentsTable">
                    <thead class="bg-light text-uppercase text-muted ultra-small">
                        <tr>
                            <th class="ps-4">Date & Time</th>
                            <th>Patient</th>
                            <th>Reason</th>
                            <th>Status</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for appt in appointments %}
                        <tr>
                            <td class="ps-4">
                                <div class="fw-bold text-dark">{{ appt.appointment_date }}</div>
                                <div class="small text-muted">{{ appt.appointment_time or '--:--' }}</div>
                            </td>
                            <td>
                                <div class="fw-bold">{{ appt.first_name }} {{ appt.last_name }}</div>
                            </td>
                            <td><span class="text-secondary small bg-light px-2 py-1 rounded">{{ appt.reason_for_visit
                                    }}</span></td>
                            <td>
                                <span
                                    class="badge {% if appt.status == 'Scheduled' %}bg-primary-subtle text-primary{% else %}bg-secondary-subtle text-secondary{% endif %}">
                                    {{ appt.status }}
                                </span>
                            </td>
                            <td class="text-end pe-4">
                                <button class="btn btn-outline-secondary btn-sm me-1 border-0" title="Edit"
                                    onclick="openEditModal('{{ appt.id }}', '{{ appt.appointment_date }}', '{{ appt.appointment_time }}', '{{ appt.reason_for_visit }}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <a href="{{ url_for('delete_booking', id=appt.id) }}"
                                    class="btn btn-outline-danger btn-sm border-0" title="Cancel"
                                    onclick="return confirm('Cancel this appointment?');">
                                    <i class="bi bi-x-lg"></i>
                                </a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">No appointments found.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editAppointmentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-primary text-white">
                <h6 class="modal-title fw-bold">Edit Appointment</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editForm" method="POST">
                <div class="modal-body p-4">
                    <div class="form-floating mb-3">
                        <input type="date" name="appointment_date" id="editDate" class="form-control" required
                            min="{{ get_today_date }}">
                        <label>New Date</label>
                    </div>
                    <div class="form-floating mb-3">
                        <input type="time" name="appointment_time" id="editTime" class="form-control" required>
                        <label>New Time</label>
                    </div>
                    <div class="form-floating">
                        <input type="text" name="reason_for_visit" id="editReason" class="form-control" required>
                        <label>Reason</label>
                    </div>
                </div>
                <div class="modal-footer bg-light border-0">
                    <button type="button" class="btn btn-link text-muted text-decoration-none"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary px-4">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            themeSystem: 'bootstrap5',
            headerToolbar: {
                left: 'title',
                right: 'prev,next today'
            },
            events: '/api/all_appointments',
            height: 550,
            eventColor: '#0d6efd',
            eventDisplay: 'block'
        });
        calendar.render();
    });

    // Search & Select
    const searchInput = document.getElementById('patientSearch');
    const resultsDiv = document.getElementById('searchResults');
    const bookingSection = document.getElementById('bookingFormSection');
    const bookingPlaceholder = document.getElementById('bookingPlaceholder');

    // Elements to populate
    const idInput = document.getElementById('selectedPatientId');
    const nameDisplay = document.getElementById('selectedPatientName');
    const detailDisplay = document.getElementById('selectedPatientDetail');

    searchInput.addEventListener('input', function () {
        const query = this.value;
        if (query.length < 2) {
            resultsDiv.innerHTML = '';
            return;
        }

        fetch(`{{ url_for('search_patient_api') }}?q=${query}`)
            .then(response => response.json())
            .then(data => {
                resultsDiv.innerHTML = '';
                if (data.length === 0) {
                    resultsDiv.innerHTML = '<div class="list-group-item text-muted small">No patients found.</div>';
                    return;
                }

                data.forEach(patient => {
                    const item = document.createElement('a');
                    item.href = "#";
                    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center px-3 py-2';
                    item.innerHTML = `
                        <div>
                            <span class="fw-bold text-dark">${patient.first_name} ${patient.last_name}</span>
                            <small class="d-block text-muted" style="font-size:0.75rem">ID: ${patient.insurance_number}</small>
                        </div>
                        <i class="bi bi-chevron-right text-muted small"></i>
                    `;
                    item.onclick = (e) => {
                        e.preventDefault();
                        selectPatient(patient);
                    };
                    resultsDiv.appendChild(item);
                });
            });
    });

    function selectPatient(patient) {
        // Show Form
        bookingPlaceholder.classList.add('d-none');
        bookingSection.classList.remove('d-none');

        // Populate
        idInput.value = patient.id;
        nameDisplay.textContent = `${patient.first_name} ${patient.last_name}`;
        detailDisplay.textContent = `ID: ${patient.insurance_number} | Age: ${patient.age}`;

        // Clean up UI
        resultsDiv.innerHTML = '';
        searchInput.value = ''; // Clear search to show we selected
    }

    function resetForm() {
        bookingSection.classList.add('d-none');
        bookingPlaceholder.classList.remove('d-none');
        searchInput.focus();
    }

    // Filter Table
    document.getElementById('searchAppt').addEventListener('keyup', function () {
        const value = this.value.toLowerCase();
        document.querySelectorAll('#appointmentsTable tbody tr').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(value) ? '' : 'none';
        });
    });

    // Edit Modal
    function openEditModal(id, date, time, reason) {
        const modal = new bootstrap.Modal(document.getElementById('editAppointmentModal'));
        document.getElementById('editForm').action = `/update_appointment_details/${id}`;
        document.getElementById('editDate').value = date;
        document.getElementById('editTime').value = time ? time.substring(0, 5) : '';
        document.getElementById('editReason').value = reason;
        modal.show();
    }
</script>
{% endblock %}