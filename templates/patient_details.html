{% extends "layout.html" %}

{% block content %}
<div class="container-fluid px-4 mt-4">
    <!-- Top Section: Patient Profile -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body p-4">
            <div class="row align-items-center">
                <div class="col-auto">
                    <img src="{{ url_for('static', filename='uploads/' + patient.image_path) if patient.image_path else 'https://via.placeholder.com/150' }}"
                        class="rounded-circle border border-3 border-white shadow-sm"
                        style="width: 100px; height: 100px; object-fit: cover;">
                </div>
                <div class="col">
                    <div class="d-flex align-items-center gap-3">
                        <h2 class="fw-bold mb-0 text-dark">{{ patient.first_name }} {{ patient.last_name }}</h2>
                        <span class="badge bg-secondary">ID: {{ patient.id }}</span>
                    </div>
                    <div class="text-muted mt-1">
                        <span class="me-3"><i class="bi bi-cake me-1"></i>{{ patient.age }} Years</span>
                        <span class="me-3"><i class="bi bi-person me-1"></i>{{ patient.gender }}</span>
                        <span><i class="bi bi-shield-check me-1"></i>{{ patient.insurance_number }}</span>
                    </div>
                </div>
                <div class="col-auto">
                    <div class="d-flex align-items-center gap-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="activeSwitch" {% if patient.is_active
                                %}checked{% endif %} onchange="toggleActiveStatus('{{ patient.id }}')">
                            <label class="form-check-label fw-bold" for="activeSwitch" id="activeLabel">
                                {% if patient.is_active %}Active{% else %}Inactive{% endif %}
                            </label>
                        </div>
                        <a href="/edit_patient/{{ patient.id }}" class="btn btn-outline-secondary">
                            <i class="bi bi-pencil me-2"></i>Edit Profile
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">


        <!-- Bottom Section: Visit Timeline -->
        <div class="col-12">
            <h5 class="fw-bold text-dark mb-3 ps-1">Visit Timeline</h5>

            {% if history %}
            <div class="timeline-container">
                {% for visit in history %}
                <div class="card border-0 shadow-sm mb-3">
                    <div
                        class="card-header bg-white border-bottom-0 py-3 d-flex justify-content-between align-items-start">
                        <div>
                            <h5 class="fw-bold text-primary mb-1">{{ visit.appointment_date }}</h5>
                            <span class="badge bg-light text-dark border">
                                {% if visit.weight %}{{ visit.weight }} kg{% else %}Weight not recorded{% endif %}
                            </span>
                        </div>
                        <button onclick="confirmDelete('{{ visit.id }}')" class="btn btn-sm btn-outline-danger border-0"
                            title="Delete Visit">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="card-body pt-0">
                        <div class="row g-3">
                            <div class="col-md-12">
                                <label class="small fw-bold text-muted">DIAGNOSIS</label>
                                <div class="fw-medium text-dark">{{ visit.diagnosis or 'N/A' }}</div>
                            </div>
                            <div class="col-md-7">
                                <label class="small fw-bold text-muted">DOCTOR'S NOTES</label>
                                <p class="small text-secondary mb-0" style="white-space: pre-line;">{{
                                    visit.clinical_notes or 'None' }}</p>
                            </div>
                            <div class="col-md-5">
                                <label class="small fw-bold text-muted">PRESCRIPTION</label>
                                <div class="p-2 bg-light rounded small text-secondary fst-italic">{{ visit.prescription
                                    or 'None' }}</div>
                            </div>
                        </div>

                        <!-- Linked Documents -->
                        {% if visit.documents %}
                        <div class="mt-3 pt-2 border-top">
                            <small class="fw-bold text-muted"><i class="bi bi-paperclip me-1"></i>ATTACHMENTS</small>
                            <div class="d-flex flex-wrap gap-2 mt-1">
                                {% for doc in visit.documents %}
                                <a href="/download_report/{{ doc.id }}" class="btn btn-sm btn-light border">
                                    <i class="bi bi-file-earmark-text me-1"></i>Report
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5 text-muted bg-light rounded border border-dashed">
                <i class="bi bi-calendar-event display-4 opacity-25 mb-3 d-block"></i>
                No appointment history found.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    // Delete Confirmation
    function confirmDelete(visitId) {
        Swal.fire({
            title: 'Delete this visit?',
            text: "This action cannot be undone.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Yes, delete it',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = "/delete_appointment/" + visitId;
            }
        });
    }

    function toggleActiveStatus(patientId) {
        fetch('/toggle_status/' + patientId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const label = document.getElementById('activeLabel');
                    if (data.new_status === 1) {
                        label.textContent = "Active";
                        label.classList.remove('text-muted');
                        label.classList.add('text-success');

                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: 'Patient marked as Active',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    } else {
                        label.textContent = "Inactive";
                        label.classList.remove('text-success');
                        label.classList.add('text-muted');

                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'info',
                            title: 'Patient marked as Inactive',
                            showConfirmButton: false,
                            timer: 1500
                        });
                    }
                } else {
                    Swal.fire('Error', 'Failed to update status', 'error');
                    // Revert switch if failed
                    document.getElementById('activeSwitch').checked = !document.getElementById('activeSwitch').checked;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'An error occurred', 'error');
                document.getElementById('activeSwitch').checked = !document.getElementById('activeSwitch').checked;
            });
    }
</script>
{% endblock %}